<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
    
<mapper namespace="com.elapid.spring01.dao.ProductDao"> <!-- 자바 파일이름 써야됨  -->
	
	<!-- 상품 갯수 카운트 쿼리 -->
	<select id="productCountDao" resultType="int">
		SELECT COUNT(*)
		FROM PRODUCT_IMAGE I
		JOIN IMAGE_DETAIL ID
		ON I.IMG_ID = ID.IMG_ID
		JOIN PRODUCT P
		ON P.P_ID = ID.P_ID
		JOIN CATEGORY_DETAIL CD
		ON P.P_ID = CD.P_ID
		JOIN CATEGORY C
		ON C.CTG_ID = CD.CTG_ID
		JOIN PRODUCT_DETAIL PD
		ON PD.P_ID = P.P_ID
		JOIN PRODUCT_SPEC S
		ON S.PS_ID = PD.PS_ID
		
		<!--  where 조건 쿼리문 -->
		${value}
	</select>
	
	<!-- 캐리어 리스트 쿼리 -->
	<select id="luggageListDao" resultType="com.elapid.spring01.dto.ProductListDto">
		SELECT * FROM PRODUCT_IMAGE I
		JOIN IMAGE_DETAIL ID 
		ON I.IMG_ID = ID.IMG_ID
		JOIN PRODUCT P
		ON P.P_ID = ID.P_ID
		JOIN CATEGORY_DETAIL CD
		ON P.P_ID = CD.P_ID
		JOIN CATEGORY C
		ON C.CTG_ID = CD.CTG_ID
		JOIN PRODUCT_DETAIL PD
		ON PD.P_ID = P.P_ID
		JOIN PRODUCT_SPEC S
		ON S.PS_ID = PD.PS_ID
		WHERE C.CTG_MAIN = 'LUGGAGE'
		LIMIT #{param1}, #{param2};
	</select>
	
	<!-- 캐리어 필터링 페이지 -->
	<select id="luggageFilterListDao" resultType="com.elapid.spring01.dto.ProductListDto">
		SELECT * FROM PRODUCT_IMAGE I
		JOIN IMAGE_DETAIL ID 
		ON I.IMG_ID = ID.IMG_ID
		JOIN PRODUCT P
		ON P.P_ID = ID.P_ID
		JOIN CATEGORY_DETAIL CD
		ON P.P_ID = CD.P_ID
		JOIN CATEGORY C
		ON C.CTG_ID = CD.CTG_ID
		JOIN PRODUCT_DETAIL PD
		ON PD.P_ID = P.P_ID
		JOIN PRODUCT_SPEC S
		ON S.PS_ID = PD.PS_ID
		WHERE C.CTG_MAIN = 'LUGGAGE'
		<if test="param1 != null">
			and 
			<foreach collection="param1" item="middle" open="(" close=")" separator="or">
				c.ctg_middle = #{middle}
			</foreach>
		</if>
		<if test="param2 != null">
			and 
			<foreach collection="param2" item="color" open="(" close=")" separator="or">
				s.ps_color = #{color}
			</foreach>
		</if>	
		<if test="param3 != null">
			and 
			<foreach collection="param3" item="func" open="(" close=")" separator="or">
				p.p_mainf = #{func}
			</foreach>
		</if>
		LIMIT #{param4}, #{param5};		
	</select>

	<!-- 제품 상세 페이지 -->
	<select id="detailViewDao" resultType="com.elapid.spring01.dto.ProductDetailDto" >
		SELECT * FROM PRODUCT_IMAGE I
		JOIN IMAGE_DETAIL ID 
		ON I.IMG_ID = ID.IMG_ID
		JOIN PRODUCT P
		ON P.P_ID = ID.P_ID
		JOIN CATEGORY_DETAIL CD
		ON P.P_ID = CD.P_ID
		JOIN CATEGORY C
		ON C.CTG_ID = CD.CTG_ID
		JOIN PRODUCT_DETAIL PD
		ON PD.P_ID = P.P_ID
		JOIN PRODUCT_SPEC S
		ON S.PS_ID = PD.PS_ID
		WHERE P.P_ID = #{param1};
	</select>
	
	<!-- 조회수 증가 -->
	<update id="increaseDetailView">
		UPDATE PRODUCT SET P_CLICKCOUNT = P_CLICKCOUNT+1 WHERE P_ID = #{param1};
	</update>
	
	<!-- 검색 리스트 -->
	<select id="searchDao" resultType="com.elapid.spring01.dto.ProductListDto">
		SELECT * FROM PRODUCT_IMAGE I
		JOIN IMAGE_DETAIL ID 
		ON I.IMG_ID = ID.IMG_ID
		JOIN PRODUCT P
		ON P.P_ID = ID.P_ID
		JOIN CATEGORY_DETAIL CD
		ON P.P_ID = CD.P_ID
		JOIN CATEGORY C
		ON C.CTG_ID = CD.CTG_ID
		JOIN PRODUCT_DETAIL PD
		ON PD.P_ID = P.P_ID
		JOIN PRODUCT_SPEC S
		ON S.PS_ID = PD.PS_ID
		WHERE ${param1} LIKE '%${param2}%';
	</select>
	
	<!-- 조회수 순 상품 리스트(top3) -->
	<select id="interestedProductListDao" resultType="com.elapid.spring01.dto.ProductListDto">
		SELECT *,
		DENSE_RANK() OVER(ORDER BY P_CLICKCOUNT DESC) P_RANK
		FROM PRODUCT_IMAGE I
		JOIN IMAGE_DETAIL ID
		ON I.IMG_ID = ID.IMG_ID
		JOIN PRODUCT P
		ON P.P_ID = ID.P_ID
		JOIN CATEGORY_DETAIL CD
		ON P.P_ID = CD.P_ID
		JOIN CATEGORY C
		ON C.CTG_ID = CD.CTG_ID
		JOIN PRODUCT_DETAIL PD
		ON PD.P_ID = P.P_ID
		JOIN PRODUCT_SPEC S
		ON S.PS_ID = PD.PS_ID
		ORDER BY P_CLICKCOUNT DESC LIMIT 0, 3;
	</select>
	
</mapper>