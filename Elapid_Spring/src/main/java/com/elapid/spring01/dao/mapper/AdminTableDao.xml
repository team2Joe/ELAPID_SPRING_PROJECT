<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
    
<mapper namespace="com.elapid.spring01.dao.AdminTableDao"> <!-- 자바 파일이름 써야됨  -->
	<select id="customerTrendTable" resultType="com.elapid.spring01.dto.customerTrendTableDto">
 	 	SELECT B.BB AS date ,B.PV AS PAGEVIEW,C.UV AS UNIQUEVISITOR, A.ORDERCOUNT,D.SIGNUPCOUNT,E.P_NAME,E.CTG_MAIN,E.CTG_MIDDLE,E.CTG_SUB, F.FUNNEL
		FROM 
			(SELECT DATE_FORMAT(UO_DATE,#{param3}) AS AA, COUNT(UOD_ID) AS ORDERCOUNT,MAX(P_ID) AS P_ID
			FROM USER_ORDER_DETAIL UOD,USER_ORDER UO 
			WHERE UO.UO_ID = UOD.UO_ID 
			AND DATE(UO_DATE) &gt;= STR_TO_DATE(#{param1}, '%Y-%m-%d') 
			AND DATE(UO_DATE) &lt;= STR_TO_DATE(#{param2}, '%Y-%m-%d')
			GROUP BY AA) AS A
		RIGHT JOIN
			(SELECT DATE_FORMAT(DATE, #{param3}) AS BB, COUNT(VISITOR_ID) AS PV
			FROM VISITOR
			WHERE DATE(DATE) &gt;= STR_TO_DATE(#{param1}, '%Y-%m-%d') 
			AND DATE(DATE) &lt;= STR_TO_DATE(#{param2}, '%Y-%m-%d')
			GROUP BY BB) AS B
		ON B.BB = A.AA
		LEFT JOIN
			(SELECT DATE_FORMAT(DATE,#{param3}) AS CC, COUNT(VISITOR_ID) AS UV
			FROM VISITOR 
			WHERE FUNNEL NOT IN ('REVISIT')
			AND DATE(DATE) &gt;= STR_TO_DATE(#{param1}, '%Y-%m-%d') 
			AND DATE(DATE) &lt;= STR_TO_DATE(#{param2}, '%Y-%m-%d')
			GROUP BY CC) AS C
		ON B.BB =C.CC
		LEFT JOIN
			(SELECT DATE_FORMAT(U_REGISTERDATE,#{param3}) AS DD, COUNT(U_ID) AS SIGNUPCOUNT 
			FROM USER
			WHERE 
			DATE(U_REGISTERDATE) &gt;= STR_TO_DATE(#{param1},'%Y-%m-%d') 
			AND DATE(U_REGISTERDATE) &lt;= STR_TO_DATE(#{param2}, '%Y-%m-%d')
			GROUP BY DD) AS D
		ON B.BB = D.DD  
		LEFT JOIN
			(SELECT SPID.DATE,SPID.P_ID,PRO.P_NAME,CTG_MAIN,CTG_MIDDLE,CTG_SUB
			FROM CATEGORY CAT,CATEGORY_DETAIL CATD,PRODUCT PRO,
			(SELECT DATE, MAX(P_ID) AS P_ID
			FROM 
			(SELECT A.AA AS DATE , MAX(ACNT) AS MAX, P_ID
			FROM
			(SELECT COUNT(P_ID) AS ACNT, P_ID, DATE_FORMAT(UO_DATE,#{param3}) AS AA
			FROM USER_ORDER_DETAIL UOD,USER_ORDER UO 
			WHERE UO.UO_ID = UOD.UO_ID 
			AND DATE(UO_DATE) &gt;= STR_TO_DATE(#{param1}, '%Y-%m-%d') 
			AND DATE(UO_DATE) &lt;= STR_TO_DATE(#{param2}, '%Y-%m-%d')
			GROUP BY AA,P_ID) AS A
			GROUP BY A.AA) AS B
			GROUP BY DATE
			ORDER BY DATE DESC) AS SPID
			WHERE CAT.CTG_ID = CATD.CTG_ID AND SPID.P_ID = CATD.P_ID AND PRO.P_ID = SPID.P_ID) AS E
		ON E.DATE = B.BB
		LEFT JOIN
			(SELECT DATE, MAX(FUNNEL) AS FUNNEL
			FROM
			(SELECT BB AS DATE,MAX(PV) AS MAXPV, FUNNEL
			FROM
			(SELECT DATE_FORMAT(DATE,#{param3}) AS BB, COUNT(VISITOR_ID) AS PV , FUNNEL 
			FROM VISITOR
			WHERE DATE(DATE) &gt;= STR_TO_DATE(#{param1}, '%Y-%m-%d') 
			AND DATE(DATE) &lt;= STR_TO_DATE(#{param2}, '%Y-%m-%d')
			AND FUNNEL != 'REVISIT'
			GROUP BY BB ,FUNNEL) AS TMP1
			GROUP BY TMP1.BB) AS TMP2
			GROUP BY DATE) AS F
		ON F.DATE = B.BB
		ORDER BY DATE DESC
	</select>
	<select id="test" resultType="String">
		
		SELECT A.AA
		FROM
		(SELECT DATE_FORMAT(UO_DATE,'%Y-%m-%d') AS AA, COUNT(UOD_ID) AS ORDERCOUNT,MAX(P_ID) AS P_ID
		FROM USER_ORDER_DETAIL UOD,USER_ORDER UO 
		WHERE UO.UO_ID = UOD.UO_ID 
		AND DATE(UO_DATE) &gt;= STR_TO_DATE(#{param1},#{param3}) 
 		AND DATE(UO_DATE) &lt;= STR_TO_DATE(#{param2}, #{param3}) 
		GROUP BY AA) AS A
		LIMIT 1
		
	</select>
</mapper>